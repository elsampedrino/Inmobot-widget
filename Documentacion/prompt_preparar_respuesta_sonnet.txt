// ============================================
// PREPARAR RESPUESTA SONNET - CON VALIDACIÃ“N
// ============================================

// VERIFICAR SI VIENE ERROR DE PASOS ANTERIORES
const inputData = $input.first().json;

if (inputData.error) {
  // Ya hay un error, pasarlo sin modificar
  return [{ json: inputData }];
}

// VERIFICAR QUE HAIKU RESPONDIÃ“ CORRECTAMENTE
if (!inputData.content || !inputData.content[0] || !inputData.content[0].text) {
  return [{
    json: {
      error: true,
      errorType: 'HAIKU_ERROR',
      errorCode: 'ERR_AI_FILTER',
      response: 'Disculpa, tuve un problema al procesar tu consulta. Â¿PodrÃ­as  reformularla de otra manera? Por ejemplo: "Busco un departamento de 2 ambientes en Palermo para alquilar".',
      timestamp: new Date().toISOString()
    }
  }];
}

// Obtener respuesta de Haiku
const haikuResponse = $input.first().json.content[0].text.trim();

// Obtener propiedades completas del nodo anterior
const todasPropiedades = $('Preparar Filtrado Haiku').first().json.propiedadesCompletas;
const consulta = $('Preparar Filtrado Haiku').first().json.consulta;
const sessionId = $('Preparar Filtrado Haiku').first().json.sessionId;

// Inicializar array de propiedades filtradas
let propiedadesFiltradas = [];

// VERIFICAR TIPO DE RESPUESTA DE HAIKU
if (haikuResponse === 'GREETING' || haikuResponse === 'NO_MATCH' || haikuResponse === 'TOO_GENERIC') {
  // NO hay propiedades para mostrar, Sonnet manejarÃ¡ estos casos especiales
  propiedadesFiltradas = [];

} else {
  // HAIKU RETORNÃ“ IDs - Filtrar propiedades especÃ­ficas
  const idsSeleccionados = haikuResponse.split(',').map(id => id.trim());

  propiedadesFiltradas = todasPropiedades.filter(p => {
    const propId = p.id || `PROP-${String(todasPropiedades.indexOf(p) + 1).padStart(3, '0')}`;
    return idsSeleccionados.some(id => id.includes(propId.split('-')[1]));
  });

  // Si no encontrÃ³ ninguna por IDs, tomar las primeras 3 como fallback
  if (propiedadesFiltradas.length === 0) {
    propiedadesFiltradas.push(...todasPropiedades.slice(0, 3));
  }
  
}

// Construir descripciÃ³n de propiedades CON FOTOS para Sonnet (solo si hay propiedades)
const propiedadesParaSonnet = propiedadesFiltradas.map(p => {
  const propInfo = {
    id: p.id,
    tipo: p.tipo,
    operacion: p.operacion,
    titulo: p.titulo,
    direccion: p.direccion,
    precio: p.precio,
    expensas: p.expensas,
    caracteristicas: p.caracteristicas,
    detalles: p.detalles,
    descripcion: p.descripcion,
    disponibilidad: p.disponibilidad
  };

  if (p.fotos && p.fotos.urls && p.fotos.urls.length > 0) {
    propInfo.fotos = {
      cantidad: p.fotos.cantidad || p.fotos.urls.length,
      urls: p.fotos.urls,
      destacados: p.fotos.destacados || []
    };
  }

  return propInfo;
});

const sonnetPayload = {
  "model": "claude-sonnet-4-20250514",
  "max_tokens": 2000,
  "messages": [
    {
      "role": "user",
      "content": `Sos un asistente inmobiliario profesional y amigable de Argentina.

CONSULTA DEL CLIENTE:
"${consulta}"

RESULTADO DEL FILTRO INTELIGENTE:
${haikuResponse}

${propiedadesFiltradas.length > 0 ? `PROPIEDADES SELECCIONADAS:\n${JSON.stringify(propiedadesParaSonnet, null, 2)}` : `No hay propiedades para mostrar`}

=== INSTRUCCIONES SEGÃšN EL TIPO DE CONSULTA ===

0. DETECCIÃ“N DE IDIOMA:
   - DetectÃ¡ automÃ¡ticamente el idioma de la consulta
   - RespondÃ© SIEMPRE en el mismo idioma que usÃ³ el cliente

1. Si el filtro respondiÃ³ "GREETING":
   - Saludo muy breve (1 lÃ­nea)
   - Ir directo al grano con opciones concretas
   - Preguntar operaciÃ³n (alquilar/comprar)
   - NO menciones propiedades especÃ­ficas
   - Ejemplo ES:

     Â¡Hola! ğŸ‘‹ Â¿QuÃ© estÃ¡s buscando?

     ğŸ¢ Departamento
     ğŸ  Casa
     ğŸª Local comercial
     ğŸŒ¾ Campo
     ğŸï¸ Terreno

     Â¿Para alquilar o comprar?

   - Ejemplo EN:
    
     Hi! ğŸ‘‹ What are you looking for?

     ğŸ¢ Apartment
     ğŸ  House
     ğŸª Commercial property
     ğŸŒ¾ Farm
     ğŸï¸ Land

     Are you looking to rent or buy?
     
   - Ejemplo PT:
     
     OlÃ¡! ğŸ‘‹ O que vocÃª procura?

     ğŸ¢ Apartamento
     ğŸ  Casa
     ğŸª ImÃ³vel comercial
     ğŸŒ¾ Campo
     ğŸï¸ Terreno

     Para alugar ou comprar?
     
2. Si el filtro respondiÃ³ "NO_MATCH":
   - ConfirmÃ¡ amablemente que NO tenÃ©s propiedades con esas caracterÃ­sticas
   - OfrecÃ© explorar otras opciones disponibles de forma genÃ©rica
   - NO inventes ubicaciones ni ofrezcas propiedades automÃ¡ticamente
   - Ejemplo ES: "Actualmente no tenemos propiedades disponibles con esas caracterÃ­sticas. PodÃ©s explorar otras opciones que tenemos disponibles."
   - Ejemplo EN: "We currently don't have properties available with those characteristics. You can explore other options we have available."
   - Ejemplo PT: "Atualmente nÃ£o temos propriedades disponÃ­veis com essas caracterÃ­sticas. VocÃª pode explorar outras opÃ§Ãµes que temos disponÃ­veis."

3. Si el filtro respondiÃ³ "TOO_GENERIC":
   - ReconocÃ© que tenÃ©s muchas opciones disponibles
   - PedÃ­ mÃ¡s detalles para afinar la bÃºsqueda
   - SugerÃ­ criterios Ãºtiles (ubicaciÃ³n, tipo, operaciÃ³n) - NO menciones "Argentina"
   - Ejemplo ES: "Â¡Tenemos muchas propiedades disponibles! Para mostrarte las mÃ¡s adecuadas, Â¿me podrÃ­as contar un poco mÃ¡s? Por ejemplo: Â¿En quÃ© zona buscÃ¡s? Â¿Para comprar o alquilar? Â¿QuÃ© tipo de propiedad te interesa?"
   - Ejemplo EN: "We have many properties available! To show you the most suitable ones, could you tell me more? For example: Which area? To buy or rent? What type of property?"
   - Ejemplo PT: "Temos muitas propriedades disponÃ­veis! Para mostrar as mais adequadas, vocÃª poderia me contar um pouco mais? Por exemplo: Em que Ã¡rea vocÃª procura? Para comprar ou alugar? Que tipo de propriedade te interessa?"

4. Si el filtro respondiÃ³ con IDs (propiedades especÃ­ficas):
   - PresentÃ¡ las propiedades de forma directa, sin repetir ni reinterpretar la consulta
   - MostrÃ¡ como mÃ¡ximo 5 propiedades. Si hay mÃ¡s, seleccionÃ¡ las mÃ¡s representativas
   - RespetÃ¡ estrictamente el orden en que se reciben las propiedades. NO reordenes por ningÃºn criterio
   - Por cada propiedad:
     * TÃ­tulo descriptivo con emoji (ğŸ  casa, ğŸ¢ depto, ğŸª local)
     * CaracterÃ­sticas en texto natural (NO bullets)
     * Precio formato argentino (USD 950/mes + $85.000 expensas)
     * **MUY IMPORTANTE - FOTOS**: Si la propiedad tiene fotos, incluÃ­ TODAS las URLs al final en UNA SOLA LÃNEA, separadas por espacios.
       Formato: ğŸ“¸ [URL_1] [URL_2] [URL_3]
     Ejemplo: "ğŸ“¸ https://res.cloudinary.com/.../foto01.jpg https://res.cloudinary.com/.../foto02.jpg https://res.cloudinary.com/.../foto03.jpg"
   - **IMPORTANTE - UBICACIÃ“N**: ComparÃ¡ la ubicaciÃ³n de cada propiedad con lo que pidiÃ³ el usuario en la consulta original.
      Si la ubicaciÃ³n es diferente pero cercana, mencionalo ANTES de mostrar esa propiedad.
      Esto aplica EN AMBAS DIRECCIONES:
      * Si pidiÃ³ "Palermo" pero mostrÃ¡s Belgrano â†’ "TambiÃ©n encontrÃ© esta opciÃ³n en Belgrano, un barrio vecino a Palermo"
      * Si pidiÃ³ "Belgrano" pero mostrÃ¡s Palermo â†’ "TambiÃ©n encontrÃ© esta opciÃ³n en Palermo, un barrio vecino a Belgrano"
      * Si pidiÃ³ "centro de Ramallo" pero mostrÃ¡s "zona norte de Ramallo" â†’ mencionar la diferencia
      * SIEMPRE comparÃ¡: consulta vs ubicaciÃ³n real de la propiedad
   - CIERRE EXACTO (sin modificar):
     * ES: "Â¿Alguna de estas propiedades te interesa? PodÃ©s:\nâœ… Dejar tus datos de contacto\nğŸ” Ver otras opciones"
     * EN: "Are any of these properties interesting? You can:\nâœ… Leave your contact information\nğŸ” See other options"
     * PT: "Alguma dessas propriedades te interessa? VocÃª pode:\nâœ… Deixar seus dados de contato\nğŸ” Ver outras opÃ§Ãµes"

FORMATO GENERAL:
- Texto natural y conversacional
- MÃ¡ximo 300 palabras
- Emojis con moderaciÃ³n (1-2 por mensaje)
- Tono profesional pero amigable

Respuesta:`
    }
  ]
};

return {
  json: {
    sonnetPayload: sonnetPayload,
    propiedadesFiltradas: propiedadesFiltradas,
    consulta: consulta,
    sessionId: sessionId,
    haikuResponse: haikuResponse
  }
};