// ============================================
// PREPARAR HAIKU TODO-EN-UNO - PLAN B√ÅSICO
// Filtrado + Respuesta en una sola llamada
// VERSI√ìN CORREGIDA PARA ESTRUCTURA BBR
// ============================================

// OBTENER INPUT
const inputData = $input.first().json;

// VALIDAR QUE LLEGARON PROPIEDADES
if (!inputData.data || typeof inputData.data !== 'string' || inputData.data.length < 10) {
  return [{
    json: {
      error: true,
      errorType: 'GITHUB_ERROR',
      errorCode: 'ERR_NO_PROPERTIES',
      response: 'Lo siento, estamos teniendo problemas t√©cnicos para acceder a nuestras propiedades. ¬øPodr√≠as intentar nuevamente en unos minutos?',
      timestamp: new Date().toISOString()
    }
  }];
}

// 1. OBTENER LA CONSULTA DEL USUARIO
const webhookData = $('Webhook Chat').first().json;
const body = webhookData.body || webhookData;
const consulta = body.message || body.consulta || body.query || "Busco una propiedad";

// 2. PARSEAR PROPIEDADES
const parsedData = JSON.parse(inputData.data);
let propiedades = [];

if (Array.isArray(parsedData.propiedades)) {
  propiedades = parsedData.propiedades;
} else if (parsedData.propiedades) {
  propiedades = parsedData.propiedades;
}

// 3. CREAR CAT√ÅLOGO COMPLETO PARA HAIKU
const catalogoCompleto = propiedades.map((p, index) => {
  const id = p.id || `PROP-${String(index + 1).padStart(3, '0')}`;

// Construir objeto con toda la info necesaria - CORREGIDO PARA BBR
  const propInfo = {
    id: id,
    tipo: p.tipo || 'Propiedad',
    operacion: p.operacion || 'Venta',
    titulo: p.titulo || `${p.tipo} en ${p.direccion?.barrio || 'Buenos Aires'}`,
    ubicacion: `${p.direccion?.calle || ''}, ${p.direccion?.barrio || ''}, ${p.direccion?.ciudad || ''}`.trim(),
    barrio: p.direccion?.barrio || 'No especificado',
    ciudad: p.direccion?.ciudad || 'No especificada',
    precio: p.precio?.valor || 'Consultar',
    moneda: p.precio?.moneda || 'USD',
    // CORREGIDO: expensas est√° dentro de precio en BBR
    expensas: p.precio?.expensas || null,
    // CORREGIDO: BBR no tiene ambientes, calcularlo si es necesario
    ambientes: (p.caracteristicas?.dormitorios || 0) + 1, // dormitorios + 1 living
    dormitorios: p.caracteristicas?.dormitorios || null,
    banios: p.caracteristicas?.banios || null,
    superficie_total: p.caracteristicas?.superficie_total || null,
    superficie_cubierta: p.caracteristicas?.superficie_cubierta || null,
    // CORREGIDO: detalles es un array en BBR, no propiedades booleanas
    detalles: Array.isArray(p.detalles) ? p.detalles : [],
    cochera: Array.isArray(p.detalles) ? p.detalles.includes('cochera') : false,
    balcon: Array.isArray(p.detalles) ? p.detalles.includes('balcon') : false,
    jardin: Array.isArray(p.detalles) ? p.detalles.includes('jardin') : false,
    patio: Array.isArray(p.detalles) ? p.detalles.includes('patio') : false,
    pileta: Array.isArray(p.detalles) ? p.detalles.includes('pileta') : false,
    quincho: Array.isArray(p.detalles) ? p.detalles.includes('quincho') : false,
    parrilla: Array.isArray(p.detalles) ? p.detalles.includes('parrilla') : false,
    descripcion: p.descripcion || '',
    estado_construccion: p.estado_construccion || null
  };

  // AGREGAR FOTOS CON ESTRUCTURA COMPLETA
  if (p.fotos && p.fotos.urls && p.fotos.urls.length > 0) {
    propInfo.fotos = {
      cantidad: p.fotos.urls.length,
      urls: p.fotos.urls
    };
  }

  return propInfo;
});

// 3.1 ORDENAR POR PRECIO ASCENDENTE
const catalogoOrdenado = [...catalogoCompleto].sort((a, b) => {
  const precioA = typeof a.precio === 'number' ? a.precio : Number.MAX_VALUE;
  const precioB = typeof b.precio === 'number' ? b.precio : Number.MAX_VALUE;
  return precioA - precioB;
});

const catalogoFinal = catalogoOrdenado.slice(0, 5);


// 4. CONSTRUIR PAYLOAD PARA HAIKU CON PROMPT MEJORADO
const haikuPayload = {
  "model": "claude-3-5-haiku-20241022",
  "max_tokens": 1500,
  "messages": [
    {
      "role": "user",
      "content": `Sos un asistente inmobiliario simple y directo para Argentina.

CONSULTA DEL CLIENTE:
"${consulta}"

CAT√ÅLOGO DE PROPIEDADES:
${JSON.stringify(catalogoFinal, null, 2)}

=== TU TAREA ===

Actu√°s como un asistente inmobiliario simple y directo para Argentina.
Cada consulta es independiente: NO hay historial ni seguimiento.

ANTES DE RESPONDER:
1. Convert√≠ la consulta del usuario a min√∫sculas.
2. Interpret√° sin√≥nimos y variaciones del lenguaje como equivalentes.

EQUIVALENCIAS OBLIGATORIAS:

OPERACI√ìN:
- alquilar, alquiler, rentar, renta ‚Üí alquiler
- comprar, compra, vender, venta ‚Üí venta

TIPO DE PROPIEDAD:
- departamento, depto, dpto ‚Üí departamento
- casa, vivienda ‚Üí casa
- local, local comercial ‚Üí local
- terreno, lote ‚Üí terreno

PLURALIZACI√ìN:
- casas ‚Üí casa
- departamentos ‚Üí departamento
- locales ‚Üí local
- terrenos ‚Üí terreno

REGLAS PRINCIPALES:

REGLA DE PRIORIDAD ABSOLUTA:
Si la consulta menciona un tipo de propiedad o una operaci√≥n,
SIEMPRE debe tratarse como CONSULTA CON CRITERIO (Tipo D),
aunque la frase sea corta, informal o tenga forma de saludo o pregunta.

A) SALUDO SIMPLE
Si la consulta SOLO contiene un saludo ("hola", "buen d√≠a", "buenas", etc.)
y NO menciona tipo de propiedad ni operaci√≥n:
‚Üí Respond√© con un saludo breve e informativo.
NO hagas preguntas.

B) B√öSQUEDA SIN RESULTADOS
Si el usuario menciona tipo y/o operaci√≥n
pero NO existe ninguna propiedad que coincida parcialmente:
‚Üí Inform√° claramente que no hay propiedades disponibles con esas caracter√≠sticas.

C) CONSULTA MUY GEN√âRICA
Si la consulta NO menciona ni tipo de propiedad NI operaci√≥n,
‚Üí RESPOND√â SIEMPRE con el formato Tipo C
NO respondas con mensajes gen√©ricos ni de espera.

D) CONSULTA CON CRITERIO (PRIORIDAD M√ÅXIMA)
Si la consulta menciona un tipo de propiedad u operaci√≥n, incluso en plural o en forma informal,
DEBE tratarse SIEMPRE como Tipo D.
NO respondas con presentaciones, descripciones de rol ni mensajes gen√©ricos.

CONSULTAS COMO:
- "qu√© propiedades ten√©s"
- "qu√© tenes?"
- "propiedades disponibles"
- "qu√© hay?"
DEBEN considerarse SIEMPRE como CONSULTA MUY GEN√âRICA (Tipo C)
y responder con el formato Tipo C.
NO uses respuestas gen√©ricas fuera de los formatos definidos.

‚Üí SIEMPRE trat√° la consulta como Tipo D.
‚Üí Busc√° coincidencias parciales en el cat√°logo.
‚Üí Si existe al menos UNA coincidencia, MOSTR√Å PROPIEDADES.
‚Üí NO hagas preguntas.

‚ö†Ô∏è REGLA CR√çTICA:
Si existe al menos UNA propiedad compatible con la intenci√≥n del usuario,
NUNCA respondas con saludo gen√©rico ni respuesta informativa.
MOSTR√Å PROPIEDADES.

FORMATO DE RESPUESTA:

üîπ SALUDO SIMPLE (Tipo A):
---
¬°Hola! Tenemos propiedades disponibles para alquilar y comprar.
---

üîπ SIN RESULTADOS (Tipo B):
---
No tenemos propiedades disponibles con esas caracter√≠sticas en este momento.
---

üîπ GEN√âRICA (Tipo C):
---
Contamos con propiedades disponibles para alquilar y comprar en distintas zonas.
---

üîπ PROPIEDADES (Tipo D):

ESTRUCTURA OBLIGATORIA:

SELECCI√ìN DE PROPIEDADES:

1. Determin√° cu√°ntas propiedades mostrar:
   - Si existen 3 o m√°s propiedades compatibles, seleccion√° EXACTAMENTE 3.
   - Si existen menos de 3, seleccion√° todas las disponibles.
   - Nunca selecciones m√°s de 5 propiedades.

2. Mostr√° √öNICAMENTE las propiedades seleccionadas.
   No menciones ni hagas referencia a otras propiedades no mostradas.

FORMATO DE RESPUESTA (Tipo D):

1. L√≠nea introductoria(OBLIGATORIA):
   La l√≠nea introductoria DEBE incluir expl√≠citamente la cantidad de propiedades.

   Ejemplos v√°lidos:
   - "Tengo 3 casas disponibles:"
   - "Encontr√© 2 departamentos para alquiler:"
   - "Encontr√© 1 propiedad para venta:"
  
   NO omitas el n√∫mero bajo ninguna circunstancia.

2. L√≠nea vac√≠a

3. Detalle de cada propiedad seleccionada:

üè¢ [T√≠tulo completo]
üìç [Calle, Barrio, Ciudad]
üí∞ [Moneda] [Precio] (si es alquiler y hay expensas: + expensas)
üõèÔ∏è [N] dormitorios, [N] ba√±os
üìè [superficie_total] ([superficie_cubierta] cubiertos)

Agregar SOLO si corresponde:
üöó Cochera
üåø Patio / Jard√≠n / Balc√≥n
üèä Pileta
üçñ Quincho / Parrilla
üì∏ [TODAS las URLs de fotos en UNA sola l√≠nea separadas por espacios]

L√≠nea vac√≠a

REGLAS FINALES:

ORDEN OBLIGATORIO DE RESULTADOS:
   - Cuando muestres propiedades (Tipo D), ordenalas SIEMPRE por precio de menor a mayor.
   - Us√° el campo num√©rico de precio (precio.valor).
   - Si alguna propiedad no tiene precio definido, mostralas AL FINAL.
   - El orden debe reflejarse tanto en el texto como en la cantidad [X] informada.

PROHIBICI√ìN ABSOLUTA:
Nunca expliques c√≥mo interpretaste la consulta.
Nunca uses frases como:
- "Dado que la consulta..."
- "Interpreto esto como..."
- "Esto corresponde a..."
Comenz√° SIEMPRE la respuesta directamente con el contenido final.
- NO expliques tu razonamiento.
- NO hagas preguntas al usuario.
- NO menciones tipos A/B/C/D.
- NO asumas continuidad.
- Siempre us√° espa√±ol argentino (voseo).
- Tono directo, claro y profesional.

RESPONDE AHORA:`

    }
  ]
};

// 5. RETORNAR DATOS
return [{
  json: {
    haikuPayload: haikuPayload,
    propiedadesCompletas: propiedades,
    consulta: consulta,
    sessionId: body.sessionId || 'session-default'
  }
}];
